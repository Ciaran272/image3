import{e as A,b as E,M as $,a as I,c as k,n as L,U as B,g as u,s as g,r as b}from"./vendor-ai-Cjay71on.js";import"./vendor-other-B_-1jgMS.js";let l=null,w=!1,f=null,s="webgl",d=null;const h=2,y={2:k,3:I,4:$};async function C(){if(!(w&&d===s&&u()===s))try{u()!==s&&(console.log(`正在切换 TensorFlow.js 后端到 ${s}...`),await g(s)),await b(),w=!0,d=u()==="webgl"?"webgl":"cpu",console.log("TensorFlow.js 后端就绪:",u())}catch(e){if(s==="webgl")console.warn("WebGL 后端初始化失败，降级至 CPU，性能可能受影响",e),s="cpu",await g("cpu"),await b(),w=!0,d="cpu",console.log("TensorFlow.js 后端就绪:",u());else throw e}}async function M(e){if(!l||f!==e){await C(),console.log(`正在初始化 AI 超分辨率模型 (scale=${e})...`);const o={model:y[e],warmupSizes:[128]};if(l)try{await l.dispose()}catch(n){console.warn("释放旧模型失败，将继续使用新模型",n)}l=new B(o),f=e}return l}async function D(e,o=2,n){const a=T(o);return m(e,a,n)}async function m(e,o,n,a=!0){try{console.log("=== 开始 AI 超分辨率处理 ==="),console.log("图片信息:",{name:e.name,size:`${(e.size/1024/1024).toFixed(2)} MB`,type:e.type}),n&&n(10),console.log("步骤1: 初始化 Upscaler 模型...");const r=await M(o);n&&n(20),console.log("步骤2: 加载图片...");const t=await F(e);console.log("图片尺寸:",`${t.width} × ${t.height}`),n&&n(30),(t.width>2e3||t.height>2e3)&&(console.warn(`⚠️ 图片尺寸较大 (${t.width}×${t.height})，AI处理可能较慢或失败`),console.warn("建议：使用更小的图片或降低放大倍数")),console.log(`步骤3: AI 超分辨率处理（放大 ${o}x）...`),console.log("这可能需要 10-30 秒，请耐心等待..."),await L();const c=await r.upscale(t,{output:"base64",patchSize:64,padding:2});return console.log("✅ AI 超分辨率处理完成！"),n&&n(100),c}catch(r){const t=r instanceof Error?r.message:String(r);if(console.error("❌ AI 超分失败，详细错误:",r),console.error("错误类型:",r instanceof Error?r.name:typeof r),console.error("错误信息:",t),a&&z(r)&&d!=="cpu"){if(typeof window<"u"&&!window.confirm("⚠️ 浏览器显卡资源不足，是否切换到 CPU 模式继续处理？（速度会明显变慢）")){const p=new Error("用户取消处理：CPU 模式未启用");throw p.userAborted=!0,p}return console.warn("检测到 WebGL 故障，尝试切换到 CPU 后端重新处理…"),await x(),n&&n(10),m(e,o,n,!1)}const c=new Error(`AI 超分失败: ${S(t)}`);throw c.skipImage=!0,c}}function T(e){return y[e]?e:(console.warn(`不支持的超分倍数 ${e}x，自动改为 ${h}x`),h)}async function U(){if(l){try{await l.dispose()}catch(e){console.warn("释放 Upscaler 实例失败",e)}l=null}f=null}async function x(){s="cpu",w=!1,await U()}function z(e){if(!(e instanceof Error))return!1;const o=`${e.message} ${e.name}`.toLowerCase();return o.includes("webgl")||o.includes("shader")||o.includes("compile")||o.includes("linkprogram")}function S(e){return e?e.includes("Set maximum size exceeded")?"超出设置最大尺寸":e:"未知错误"}async function G(){s="webgl",w=!1,d=null,await U();try{A().disposeVariables()}catch(e){console.warn("清理 TensorFlow 变量失败",e)}try{const e=E();e&&typeof e.dispose=="function"&&e.dispose()}catch(e){console.warn("释放 TensorFlow Backend 失败",e)}}function F(e){return new Promise((o,n)=>{const a=new Image,r=new FileReader;r.onload=t=>{var c;a.src=(c=t.target)==null?void 0:c.result},a.onload=()=>o(a),a.onerror=()=>n(new Error("图片加载失败")),r.readAsDataURL(e)})}function W(e){const o=e.split(";base64,"),n=o[0].split(":")[1],a=window.atob(o[1]),r=a.length,t=new Uint8Array(r);for(let i=0;i<r;++i)t[i]=a.charCodeAt(i);const c=new Blob([t],{type:n});return URL.createObjectURL(c)}export{D as aiUpscale,W as base64ToBlobUrl,G as resetAIBackend};
